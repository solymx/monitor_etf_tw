<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ETF æŒè‚¡æˆ°æƒ…å®¤ - 5å°å¤§æœƒå¸«</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
.card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
.card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; border-radius: 12px 12px 0 0 !important; }
.badge-fund { font-size: 0.85em; margin-right: 4px; padding: 6px 10px; border-radius: 20px; }
/* é¡è‰²å®šç¾© */
.bg-980a { background-color: #e3f2fd; color: #0d6efd; border: 1px solid #b6d4fe; }
.bg-981a { background-color: #f8d7da; color: #dc3545; border: 1px solid #f5c6cb; }
.bg-982a { background-color: #d1e7dd; color: #198754; border: 1px solid #badbcc; }
.bg-985a { background-color: #fff3cd; color: #ffc107; border: 1px solid #ffecb5; }
.bg-991a { background-color: #f3e5f5; color: #9c27b0; border: 1px solid #e1bee7; }

.consensus-high { color: #dc3545; font-weight: bold; } 
.consensus-mid { color: #fd7e14; font-weight: bold; }

#loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.metric-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
.metric-label { color: #6c757d; font-size: 0.8rem; }
.col-custom { flex: 0 0 auto; width: 20%; }
@media (max-width: 768px) { .col-custom { width: 50%; } }
</style>
</head>
<body>

<div id="loading">
<div class="spinner-border text-primary mb-3" role="status"></div>
<h5>æ­£åœ¨åˆ†æ 5 æª” ETF è³‡æ–™...</h5>
</div>

<div class="container py-4">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-center gap-2 flex-wrap">
            <a href="980a.html" class="btn btn-outline-primary fw-bold">980a</a>
            <a href="981a.html" class="btn btn-outline-danger fw-bold">981a</a>
            <a href="982a.html" class="btn btn-outline-success fw-bold">982a</a>
            <a href="985a.html" class="btn btn-outline-warning text-dark fw-bold">985a</a>
            <a href="991a.html" class="btn btn-outline-info fw-bold" style="color:#9c27b0; border-color:#9c27b0;">991a</a>
        </div>
    </div>

    <div class="row mb-4 text-center">
        <div class="col-12">
            <h2 class="fw-bold text-primary">ğŸ“Š ETF æŒè‚¡äº¤å‰æ¯”å° (å« 991a)</h2>
        </div>
    </div>

    <div class="row text-center mb-4">
        <div class="col-custom mb-3">
            <div class="card p-2"><div class="metric-value" id="total-stocks">0</div><div class="metric-label">ç¸½æŒè‚¡æ•¸</div></div>
        </div>
        <div class="col-custom mb-3">
            <div class="card p-2"><div class="metric-value text-danger" id="consensus-5">0</div><div class="metric-label">5å®¶æŒæœ‰ ğŸ”¥</div></div>
        </div>
        <div class="col-custom mb-3">
            <div class="card p-2"><div class="metric-value text-danger" id="consensus-4">0</div><div class="metric-label">4å®¶æŒæœ‰</div></div>
        </div>
        <div class="col-custom mb-3">
            <div class="card p-2"><div class="metric-value text-warning" id="consensus-3">0</div><div class="metric-label">3å®¶æŒæœ‰</div></div>
        </div>
        <div class="col-custom mb-3">
            <div class="card p-2"><div class="metric-value text-success" id="consensus-2">0</div><div class="metric-label">2å®¶æŒæœ‰</div></div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">ğŸ† ç†±é–€æŒè‚¡åœ–è¡¨ (æŒæœ‰ >= 3å®¶)</div>
        <div class="card-body"><canvas id="holdingsChart" height="80"></canvas></div>
    </div>

    <div class="card">
        <div class="card-header">ğŸ“‹ è©³ç´°æŒè‚¡æ¸…å–®</div>
        <div class="card-body">
            <div class="table-responsive">
                <table id="stocksTable" class="table table-hover align-middle w-100">
                    <thead>
                        <tr>
                            <th>ä»£è™Ÿ</th>
                            <th>è‚¡ç¥¨åç¨±</th>
                            <th class="text-center">è¢«æŒæœ‰æ•¸</th>
                            <th>åˆè¨ˆæ¬Šé‡</th>
                            <th>æŒæœ‰è€…æ˜ç´°</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
const files = [
    { id: '980a', name: '980a', file: '980a.csv', color: 'bg-980a' },
    { id: '981a', name: '981a', file: '981a.csv', color: 'bg-981a' },
    { id: '982a', name: '982a', file: '982a.csv', color: 'bg-982a' },
    { id: '985a', name: '985a', file: '985a.csv', color: 'bg-985a' },
    { id: '991a', name: '991a', file: '991a.csv', color: 'bg-991a' }
];

let stockData = {};

$(document).ready(() => {
    const promises = files.map(f => new Promise(resolve => {
        Papa.parse(f.file, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: results => {
                console.log(`è®€å– ${f.id} æˆåŠŸï¼Œå…± ${results.data.length} ç­†`);
                processData(f.id, results.data);
                resolve();
            },
            error: () => { console.error(`ç„¡æ³•è®€å– ${f.file}`); resolve(); }
        });
    }));

    Promise.all(promises).then(() => {
        renderDashboard();
        $('#loading').fadeOut();
    });
});

function processData(fundId, data) {
    data.forEach((row, index) => {
        // é—œéµä¿®æ”¹ï¼šå¢åŠ æ›´å¤šå¯èƒ½çš„æ¬„ä½è­˜åˆ¥åç¨±
        let code = row['è‚¡ç¥¨ä»£è™Ÿ'] || row['ä»£è™Ÿ'] || row['è­‰åˆ¸ä»£è™Ÿ'] || row['è¨¼åˆ¸ä»£è™Ÿ'] || row['Stock Code'] || row['æˆåˆ†è‚¡ä»£è™Ÿ'];
        let name = row['è‚¡ç¥¨åç¨±'] || row['åç¨±'] || row['è­‰åˆ¸åç¨±'] || row['è¨¼åˆ¸åç¨±'] || row['Name'] || row['æˆåˆ†è‚¡åç¨±'];
        let weight = row['æ¬Šé‡(%)'] || row['æ¬Šé‡%'] || row['æ¬Šé‡'] || row['Weight'] || 0;

        if (code && name) {
            code = code.toString().trim().replace(".TW", ""); // å»é™¤å¯èƒ½çš„å¾Œç¶´
            name = name.toString().trim();
            
            if (!stockData[code]) {
                stockData[code] = { name: name, holders: [], weights: [] };
            }
            if (!stockData[code].holders.includes(fundId)) {
                stockData[code].holders.push(fundId);
                stockData[code].weights.push({ fund: fundId, val: parseFloat(weight) || 0 });
            }
        }
    });
}

function renderDashboard() {
    const stocksArray = Object.keys(stockData).map(key => {
        let sumWeight = stockData[key].weights.reduce((acc, curr) => acc + curr.val, 0);
        return {
            code: key,
            ...stockData[key],
            count: stockData[key].holders.length,
            totalWeight: sumWeight.toFixed(2)
        };
    });

    // æ›´æ–°é¢æ¿æ•¸æ“š
    $('#total-stocks').text(stocksArray.length);
    $('#consensus-5').text(stocksArray.filter(s => s.count === 5).length);
    $('#consensus-4').text(stocksArray.filter(s => s.count === 4).length);
    $('#consensus-3').text(stocksArray.filter(s => s.count === 3).length);
    $('#consensus-2').text(stocksArray.filter(s => s.count === 2).length);

    // åœ–è¡¨
    let chartData = stocksArray.filter(s => s.count >= 3).sort((a, b) => b.count - a.count).slice(0, 20);
    const ctx = document.getElementById('holdingsChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(s => `${s.name}`),
            datasets: [{
                data: chartData.map(s => s.count),
                backgroundColor: chartData.map(s => s.count >= 4 ? '#dc3545' : '#ffc107')
            }]
        },
        options: { plugins: { legend: false }, scales: { y: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } } } }
    });

    // è¡¨æ ¼æ¸²æŸ“
    const tableBody = $('#stocksTable tbody').empty();
    stocksArray.forEach(stock => {
        let badges = files.map(f => stock.holders.includes(f.id) ? `<span class="badge ${f.color} badge-fund">${f.name}</span>` : '').join('');
        let countClass = stock.count >= 4 ? 'consensus-high' : (stock.count === 3 ? 'consensus-mid' : '');
        let stockLink = `https://tw.stock.yahoo.com/quote/${stock.code}`;

        tableBody.append(`
            <tr>
                <td><a href="${stockLink}" target="_blank" class="badge bg-secondary text-decoration-none">${stock.code}</a></td>
                <td class="fw-bold">${stock.name}</td>
                <td class="text-center ${countClass}">${stock.count}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="me-2 small">${stock.totalWeight}%</span>
                        <div class="progress flex-grow-1" style="height: 6px;">
                            <div class="progress-bar bg-info" style="width: ${Math.min(stock.totalWeight * 5, 100)}%"></div>
                        </div>
                    </div>
                </td>
                <td>${badges}</td>
            </tr>
        `);
    });

    $('#stocksTable').DataTable({ "order": [[ 2, "desc" ]], "pageLength": 25, "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/zh-HANT.json" } });
}
</script>
</body>
</html>
