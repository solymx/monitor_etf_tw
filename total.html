<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ETF æŒè‚¡æˆ°æƒ…å®¤</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; }
.card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
.card-header { background-color: #fff; border-bottom: 1px solid #eee; font-weight: bold; border-radius: 12px 12px 0 0 !important; }
.badge-fund { font-size: 0.85em; margin-right: 4px; padding: 6px 10px; border-radius: 20px; }
.bg-980a { background-color: #e3f2fd; color: #0d6efd; border: 1px solid #b6d4fe; }
.bg-981a { background-color: #f8d7da; color: #dc3545; border: 1px solid #f5c6cb; }
.bg-982a { background-color: #d1e7dd; color: #198754; border: 1px solid #badbcc; }
.bg-985a { background-color: #fff3cd; color: #ffc107; border: 1px solid #ffecb5; }
.bg-fff { background-color: #fff; }

.consensus-high { color: #dc3545; font-weight: bold; } /* 4å®¶æŒæœ‰ */
.consensus-mid { color: #fd7e14; font-weight: bold; } /* 3å®¶æŒæœ‰ */

#loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
.metric-value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
.metric-label { color: #6c757d; font-size: 0.9rem; }
</style>
</head>
<body>

<div id="loading">
<div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
<h5>æ­£åœ¨è®€å–ä¸¦åˆ†æ CSV è³‡æ–™...</h5>
<p class="text-muted small">è«‹ç¢ºä¿æª”æ¡ˆå·²ä¸Šå‚³ä¸”åç¨±æ­£ç¢º</p>
</div>

<div class="container py-4">

<div class="row mb-3">
    <div class="col-12 d-flex justify-content-center gap-2">
        <a href="980a.html" class="btn btn-outline-primary fw-bold">980a</a>
        <a href="981a.html" class="btn btn-outline-danger fw-bold">981a</a>
        <a href="982a.html" class="btn btn-outline-success fw-bold">982a</a>
        <a href="985a.html" class="btn btn-outline-warning text-dark fw-bold">985a</a>
    </div>
</div>
<div class="row mb-4">
    <div class="col-12 text-center">
        <h2 class="fw-bold text-primary">ğŸ“Š ETF æŒè‚¡äº¤å‰æ¯”å°å„€è¡¨æ¿</h2>
        <p class="text-secondary">è³‡æ–™ä¾†æºï¼š980a, 981a, 982a, 985a</p>
    </div>
</div>

<div class="row text-center">
    <div class="col-md-3">
        <div class="card p-3">
            <div class="metric-value" id="total-stocks">0</div>
            <div class="metric-label">ç¸½æŒè‚¡æ•¸ (ä¸é‡è¤‡)</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <div class="metric-value text-danger" id="consensus-4">0</div>
            <div class="metric-label">4å®¶å…±åŒæŒæœ‰ ğŸ”¥</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <div class="metric-value text-warning" id="consensus-3">0</div>
            <div class="metric-label">3å®¶å…±åŒæŒæœ‰</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card p-3">
            <div class="metric-value text-success" id="consensus-2">0</div>
            <div class="metric-label">2å®¶å…±åŒæŒæœ‰</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">ğŸ† æœ€ç†±é–€æŒè‚¡ (æŒæœ‰æª”æ•¸ >= 3)</div>
            <div class="card-body">
                <canvas id="holdingsChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>ğŸ“‹ è©³ç´°æŒè‚¡æ¸…å–®</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="stocksTable" class="table table-hover align-middle w-100">
                        <thead>
                            <tr>
                                <th>ä»£è™Ÿ</th>
                                <th>è‚¡ç¥¨åç¨±</th>
                                <th class="text-center">è¢«æŒæœ‰æ•¸</th>
                                <th>åˆè¨ˆæ¬Šé‡</th>
                                <th>æŒæœ‰è€…æ˜ç´°</th>
                                <th class="d-none">æ¬Šé‡æ’åºç”¨</th> </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<script>
// è¨­å®š CSV æª”æ¡ˆæ¸…å–® (è«‹ç¢ºä¿é€™äº›æª”æ¡ˆèˆ‡ index.html åœ¨åŒä¸€ç›®éŒ„ä¸‹)
const files = [
    { id: '980a', name: '980a', file: '980a.csv', color: 'bg-980a' },
    { id: '981a', name: '981a', file: '981a.csv', color: 'bg-981a' },
    { id: '982a', name: '982a', file: '982a.csv', color: 'bg-982a' }, // æ³¨æ„é€™è£¡ç”¨äº†ä½ ä¸Šå‚³çš„åŸå§‹æª”å
    { id: '985a', name: '985a', file: '985a.csv', color: 'bg-985a' }
];

let stockData = {}; // { '2330': { name: 'å°ç©é›»', holders: ['980a', ...], weights: {} } }

// åˆå§‹åŒ–
$(document).ready(function() {
    fetchAllFiles();
});

function fetchAllFiles() {
    let promises = files.map(f => {
        return new Promise((resolve, reject) => {
            Papa.parse(f.file, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(f.id, results.data);
                    resolve();
                },
                error: function(err) {
                    console.error("Error parsing " + f.file, err);
                    // å³ä½¿å¤±æ•—ä¹Ÿ resolveï¼Œé¿å…å¡ä½
                    resolve(); 
                }
            });
        });
    });

    Promise.all(promises).then(() => {
        renderDashboard();
        $('#loading').fadeOut();
    });
}

function processData(fundId, data) {
    data.forEach(row => {
        // è™•ç†æ¬„ä½åç¨±ä¸ä¸€è‡´çš„å•é¡Œ
        // å¸¸è¦‹æ¬„ä½: è‚¡ç¥¨ä»£è™Ÿ, è‚¡ç¥¨åç¨±, æ¬Šé‡(%), æ¬Šé‡%
        let code = row['è‚¡ç¥¨ä»£è™Ÿ'] || row['ä»£è™Ÿ'];
        let name = row['è‚¡ç¥¨åç¨±'] || row['åç¨±'];
        
        // å˜—è©¦æŠ“å–æ¬Šé‡ (å¯èƒ½ç‚ºå­—ä¸²ï¼Œéœ€è½‰æµ®é»æ•¸)
        let weight = row['æ¬Šé‡(%)'] || row['æ¬Šé‡%'] || row['æ¬Šé‡'] || 0;
        
        if (code && name) {
            code = code.toString().trim();
            name = name.toString().trim();
            
            if (!stockData[code]) {
                stockData[code] = {
                    name: name,
                    holders: [],
                    weights: []
                };
            }
            
            // ç¸½æ˜¯ä½¿ç”¨è¼ƒé•·çš„åç¨± (é¿å…ç°¡ç¨±)
            if (name.length > stockData[code].name.length) {
                stockData[code].name = name;
            }

            if (!stockData[code].holders.includes(fundId)) {
                stockData[code].holders.push(fundId);
                stockData[code].weights.push({ fund: fundId, val: parseFloat(weight) });
            }
        }
    });
}

function renderDashboard() {
    const tableBody = $('#stocksTable tbody');
    
    // 1. æ•´ç†æ•¸æ“šä¸¦è¨ˆç®—åˆè¨ˆæ¬Šé‡
    const stocksArray = Object.keys(stockData).map(key => {
        // è¨ˆç®—è©²è‚¡ç¥¨åœ¨æ‰€æœ‰ ETF ä¸­çš„æ¬Šé‡ç¸½å’Œ
        let sumWeight = stockData[key].weights.reduce((acc, curr) => acc + curr.val, 0);
        
        return {
            code: key,
            ...stockData[key],
            count: stockData[key].holders.length,
            totalWeight: sumWeight.toFixed(2) // å–å°æ•¸é»å¾Œå…©ä½
        };
    });

    // æ›´æ–°ä¸Šæ–¹å¡ç‰‡æ•¸æ“š
    $('#total-stocks').text(stocksArray.length);
    $('#consensus-4').text(stocksArray.filter(s => s.count === 4).length);
    $('#consensus-3').text(stocksArray.filter(s => s.count === 3).length);
    $('#consensus-2').text(stocksArray.filter(s => s.count === 2).length);

    // æº–å‚™åœ–è¡¨æ•¸æ“š
    let chartData = stocksArray.filter(s => s.count >= 3).sort((a, b) => b.count - a.count);
    if(chartData.length > 20) chartData = chartData.slice(0, 20);

    // ç¹ªè£½åœ–è¡¨ (è‹¥å·²å­˜åœ¨å‰‡å…ˆéŠ·æ¯€ï¼Œé¿å…é‡ç–Š)
    const ctx = document.getElementById('holdingsChart').getContext('2d');
    if (window.myChart) window.myChart.destroy(); // é˜²æ­¢åœ–è¡¨é‡è¤‡æ¸²æŸ“
    window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(s => `${s.name} (${s.code})`),
            datasets: [{
                label: 'è¢«æŒæœ‰æª”æ•¸',
                data: chartData.map(s => s.count),
                backgroundColor: chartData.map(s => s.count === 4 ? '#dc3545' : '#ffc107'),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // æ¸²æŸ“è¡¨æ ¼
    tableBody.empty(); // æ¸…ç©ºèˆŠè³‡æ–™
    stocksArray.forEach(stock => {
        // ç”¢ç”ŸæŒæœ‰è€…å¾½ç« 
        let badges = '';
        files.forEach(f => {
            if (stock.holders.includes(f.id)) {
                badges += `<span class="badge ${f.color} badge-fund">${f.name}</span>`;
            }
        });

        let countClass = '';
        if (stock.count === 4) countClass = 'consensus-high';
        else if (stock.count === 3) countClass = 'consensus-mid';

        // ç”¢ç”Ÿæ¬Šé‡æ¢ (æœ€é«˜è¨­ç‚º 5% å¡«æ»¿ï¼Œå¯è‡ªå·±èª¿æ•´é¡¯ç¤ºæ¯”ä¾‹)
        // é€™è£¡è¨­å®š width: min(weight * 20, 100) æ„æ€æ˜¯ 5% å°±æœƒæ»¿æ ¼ï¼Œè®“è¦–è¦ºå·®ç•°æ˜é¡¯ä¸€é»
        let weightBar = `
            <div class="d-flex align-items-center" style="min-width: 100px;">
                <span class="me-2 small fw-bold">${stock.totalWeight}%</span>
                <div class="progress flex-grow-1" style="height: 6px;">
                    <div class="progress-bar bg-info" role="progressbar" 
                         style="width: ${Math.min(stock.totalWeight * 20, 100)}%"></div>
                </div>
            </div>
        `;

        // Yahoo è‚¡å¸‚é€£çµ
        let stockLink = `https://tw.stock.yahoo.com/quote/${stock.code}`;

        tableBody.append(`
            <tr>
                <td>
                    <a href="${stockLink}" target="_blank" class="badge bg-secondary text-decoration-none" title="é»æ“ŠæŸ¥çœ‹è‚¡åƒ¹">
                        ${stock.code} ğŸ”—
                    </a>
                </td>
                <td class="fw-bold">
                    <a href="${stockLink}" target="_blank" class="text-dark text-decoration-none">
                        ${stock.name}
                    </a>
                </td>
                <td class="text-center ${countClass}" style="font-size:1.2em;">${stock.count}</td>
                <td>${weightBar}</td> <td>${badges}</td>
                <td class="d-none">${stock.count}</td>
            </tr>
        `);
    });

    // å•Ÿå‹• DataTables (å¦‚æœå·²ç¶“åˆå§‹åŒ–éï¼Œè¦å…ˆéŠ·æ¯€å†é‡å»º)
    if ($.fn.DataTable.isDataTable('#stocksTable')) {
        $('#stocksTable').DataTable().destroy();
    }
    
    $('#stocksTable').DataTable({
        "order": [[ 2, "desc" ]], 
        "pageLength": 25,
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/zh-HANT.json"
        }
    });
}
</script>
</body>
</html>
